#include <iostream>
#include <unistd.h>

#include "IPlot.h"

#include "fcontrol.h"

using namespace std;


int main()
{

    double dts=0.01;

    IPlot pt(dts);


//    TimeSignal dirac(valarray<double> {1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
//                ,dts);
//        FSystemBlock con(dirac);

//    //fractional integrator FIR s^-0.857
//    TimeSignal fi_085(valarray<double> {0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.9*0.55171687002097958,0.8*0.55171687002097958,0.7*0.55171687002097958,0.6*0.55171687002097958,0.5*0.55171687002097958,0.4*0.55171687002097958,0.3*0.55171687002097958,0.2*0.55171687002097958,0.1*0.55171687002097958,0.0*0.55171687002097958}
////    TimeSignal fi_085(valarray<double> {0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,1.0*0.55171687002097958,0.8*0.55171687002097958,0.6*0.55171687002097958,0.4*0.55171687002097958,0.2*0.55171687002097958,0.0*0.55171687002097958}
////    TimeSignal fi_085(valarray<double> {0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958/1,0.55171687002097958/2,0.55171687002097958/3,0.55171687002097958/4,0.55171687002097958/5,0.55171687002097958/6,0.55171687002097958/7,0.55171687002097958/8,0.55171687002097958/9,0.55171687002097958/10,0.55171687002097958/11,0.55171687002097958/12,0.55171687002097958/13,0.55171687002097958/14,0.55171687002097958/15,0.55171687002097958/16,0.55171687002097958/17,0.55171687002097958/18,0.55171687002097958/19,0.55171687002097958/20}
////    TimeSignal fi_085(valarray<double> {0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0.55171687002097958,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}


//                ,dts);
//    FSystemBlock con(fi_085);

////    //flat phase cancellator
////    TimeSignal cancs(valarray<double> {    6.3000000000000007,57.583007590444325,42.155629165742106,48.755411749345448,41.398780021230039,44.291826131801301,39.101677502251476,40.561443553611234,36.395956557292834,37.082693942716602,33.524116079923715,33.719396535807014,30.568797555545373,30.418381145804616,27.565816709952234,27.154608517621973,24.533227153579407,23.914717178568356,21.481143182355204,20.690897851393281,18.415701799744195,17.478249752736915,15.340875013674525,14.273508395463303,12.259382020718288,11.074378837935999,9.1731853142039093,7.8791602612337464,6.0837795035241058,4.6865200368106201,2.9923711830133541,1.495347752342731,-0.099999999999999645,-1.6953477523427303,-3.192371183013357,-4.8865200368106159,-6.2837795035241051,-8.0791602612337421,-9.3731853142039103,-11.274378837935998,-12.459382020718287,-14.473508395463302,-15.540875013674526,-17.67824975273691,-18.615701799744194,-20.890897851393284,-21.681143182355203,-24.114717178568355,-24.73322715357941,-27.354608517621973,-27.765816709952233,-30.618381145804619,-30.768797555545373,-33.91939653580701,-33.724116079923711,-37.282693942716598,-36.595956557292837,-40.76144355361123,-39.301677502251479,-44.491826131801304,-41.598780021230041,-48.955411749345444,-42.355629165742108,-57.783007590444321 }
////                ,dts);
////    FSystemBlock canc(cancs);

//        //motor dts=1
//    SystemBlock motor(vector<double>{1, 1},
//                      vector<double>{-1, 3},
//                      1
//                      );

//    //motor dts=0.01
//    SystemBlock motor(vector<double>{1, 1},
//                      vector<double>{-13, 15},
//                      1
//                      );

    //motor dts=0.01
    SystemBlock motor(vector<double>{1, 1},
                      vector<double>{-0.9048, 1},
                      0.047619
                      );

//    SystemBlock con(vector<double>{0,1},
//                      vector<double>{-1,1},
//                      1);

//    //dts=1
//    FactorSystemBlock con(vector<double>{(0.768576),(0.0589572),(-0.597801),(-0.956103)},
//                           vector<double>{(0.967308),(0.575831),(-0.201927),(-0.747576)},
//                           28.73);

//    //dts=0.01 //w=20
//    FactorSystemBlock con(vector<double>{0.9974,   0.9832,   0.9317,   0.7005},
//                           vector<double>{0.999,   0.9946,   0.9703 ,  0.8705},
//                           4.725);

//    //dts=0.01 //w=5
//    FactorSystemBlock con(vector<double>{0.9969 ,  0.9801 ,  0.9356  , 0.8795},
//                           vector<double>{1.0000 ,  0.9964 ,  0.9773 ,  0.8977},
//                           0.61926 );

//    //dts=0.01 //w=10 pm60
//    FactorSystemBlock con(vector<double>{0.9969  , 0.9795 ,  0.9104 ,  0.7040},
//                           vector<double>{1.0000  , 0.9964   ,0.9773 ,  0.8977},
//                           0.78689 );

//    //dts=0.01 //w=25 pm60
//    FactorSystemBlock con(vector<double>{0.9970 ,  0.9807 ,  0.9207  , 0.7470},
//                           vector<double>{0.9999 ,  0.9960 ,  0.9755  , 0.8907},
//                           2.0502 );

//    //dts=0.01 //w=25 pm60 (simplified)
//    FactorSystemBlock con(vector<double>{  0.9807 ,  0.9207  , 0.7470},
//                           vector<double>{0.9999 ,    0.9755  , 0.8907},
//                           2.0502 );

    //dts=0.01 //w=25 pm60
    FactorSystemBlock con(vector<double>{ 0.7470, 0.9970 ,  0.9207  ,  0.9807},
                          vector<double>{0.8907 , 0.9999,  0.9755  ,  0.9960 },
                          2.0502 );

    double out;
    double target=1;
    double error=0;
    double show;

    for(double t=0;t<1;t+=dts)
    {

        //1-update inputs
        error = target - motor.GetState();

        //2-control diagram
        out= error  > con;
        (out) >  motor;

        //3-update outputs

        //3-update graphs and cout
        show=motor.GetState();
        pt.pushBack(show);
        cout << "t: " << t << ", plotdata: " << show << endl;
        sleep(dts);

    }

    pt.Plot();


    return 0;
}
